{% extends "base.html" %}
{% block content %}
<div class="filters card">
	<form method="get" class="filters-form">
		<input type="text" name="q" placeholder="Search title, description, location" value="{{ args.get('q','') }}" />
		<select name="category">
			<option value="">All Categories</option>
			{% for c in ['Pothole','Street Light','Garbage','Water','Electricity','Public Safety','Other'] %}
			<option value="{{ c }}" {% if args.get('category')==c %}selected{% endif %}>{{ c }}</option>
			{% endfor %}
		</select>
		<select name="status">
			<option value="">All Status</option>
			{% for s in ['Reported','In Progress','Resolved'] %}
			<option value="{{ s }}" {% if args.get('status')==s %}selected{% endif %}>{{ s }}</option>
			{% endfor %}
		</select>
		<select name="sort">
			<option value="hot" {% if args.get('sort','hot')=='hot' %}selected{% endif %}>Hot</option>
			<option value="top" {% if args.get('sort')=='top' %}selected{% endif %}>Top</option>
			<option value="urgent" {% if args.get('sort')=='urgent' %}selected{% endif %}>Urgent</option>
			<option value="new" {% if args.get('sort')=='new' %}selected{% endif %}>New</option>
		</select>
		<button class="btn btn-secondary" type="submit">Apply</button>
	</form>
</div>

<div class="feed" style="max-width: 820px; margin: 0 auto; display: grid; gap: 16px; padding: 0 16px 24px;">
	{% for issue in issues %}
	<div class="card" style="padding: 0;">
		{% if issue.get('photo') %}
		<img src="{{ url_for('uploaded_file', filename=issue['photo']) }}" alt="Issue photo" style="width:100%; max-height: 420px; object-fit: cover; border-top-left-radius: var(--radius); border-top-right-radius: var(--radius);" />
		{% endif %}
		<div class="card-body" style="padding: 16px;">
			<div class="row space-between" style="gap:8px;">
				<div>
					<div class="chip chip-{{ issue['status']|lower|replace(' ','-') }}">{{ issue['status'] }}</div>
					<div class="chip chip-urgency">{{ issue.get('urgency','Normal') }}</div>
				</div>
				<div class="muted">{{ issue['created_at'].strftime('%Y-%m-%d %H:%M') }}</div>
			</div>
			<h3 class="card-title" style="margin-top:8px;">{{ issue['title'] }}</h3>
			<p class="muted">{{ issue['category'] }} • {{ issue.get('location_text','') }}</p>
			<p style="margin-top:8px;">{{ issue.get('description','') }}</p>

			<div class="row space-between" style="margin-top: 12px;">
				<form method="post" action="{{ url_for('upvote_issue', issue_id=issue['_id']|string) }}">
					<button class="btn btn-secondary" type="submit">▲ Like ({{ issue.get('upvotes_count', 0) }})</button>
				</form>
				<a class="btn btn-outline" href="{{ url_for('issue_detail', issue_id=issue['_id']|string) }}">View details</a>
			</div>
		</div>
	</div>
	{% else %}
	<p class="muted">No issues yet.</p>
	{% endfor %}
</div>
{% endblock %}